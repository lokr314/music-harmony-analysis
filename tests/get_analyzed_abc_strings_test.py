from src.abcjs_interface import get_analyzed_abc_strings


def test_get_analyzed_abc_strings_empty_lines():
    truncated_lines = []
    analysis_abc_strings, informations, error = get_analyzed_abc_strings(truncated_lines)
    assert analysis_abc_strings == ''
    assert informations == []
    assert error == 'No lines found.'

def test_get_analyzed_abc_strings_empty_staff_in_line_with_other_staffs():
    """
    Tested music:

    X: 1
    T: Test
    M:C|
    L:1/8
    Q:1/4=78
    %%score (1 2) (3)
    V:1  clef=treble  name="Eins"   snm="1"
    V:2  clef=treble  name="Zwei"  snm="2"
    V:3  clef=bass    name="Drei"    snm="3"  octave=-2
    K: C
    %1
    [V:1] | c2d2e2f2 | ggffeedd |
    [V:2] | __D4 G4 | G2A2G2A2 |
    [V:3] |||
    """
    truncated_lines = [{"staff":[{"voices":[[{"el_type":"stem","direction":"up"},{"type":"bar_thin","el_type":"bar"},{"pitches":[{"pitch":7,"name":"c","verticalPos":7,"highestVert":13}],"duration":0.25,"el_type":"note","averagepitch":7,"minpitch":7,"maxpitch":7},{"pitches":[{"pitch":8,"name":"d","verticalPos":8,"highestVert":14}],"duration":0.25,"el_type":"note","averagepitch":8,"minpitch":8,"maxpitch":8},{"pitches":[{"pitch":9,"name":"e","verticalPos":9,"highestVert":15}],"duration":0.25,"el_type":"note","averagepitch":9,"minpitch":9,"maxpitch":9},{"pitches":[{"pitch":10,"name":"f","verticalPos":10,"highestVert":16}],"duration":0.25,"el_type":"note","averagepitch":10,"minpitch":10,"maxpitch":10},{"type":"bar_thin","el_type":"bar"},{"pitches":[{"pitch":11,"name":"g","verticalPos":11,"highestVert":17}],"duration":0.125,"el_type":"note","startBeam":True,"averagepitch":11,"minpitch":11,"maxpitch":11},{"pitches":[{"pitch":11,"name":"g","verticalPos":11,"highestVert":17}],"duration":0.125,"el_type":"note","averagepitch":11,"minpitch":11,"maxpitch":11},{"pitches":[{"pitch":10,"name":"f","verticalPos":10,"highestVert":16}],"duration":0.125,"el_type":"note","averagepitch":10,"minpitch":10,"maxpitch":10},{"pitches":[{"pitch":10,"name":"f","verticalPos":10,"highestVert":16}],"duration":0.125,"el_type":"note","averagepitch":10,"minpitch":10,"maxpitch":10},{"pitches":[{"pitch":9,"name":"e","verticalPos":9,"highestVert":15}],"duration":0.125,"el_type":"note","averagepitch":9,"minpitch":9,"maxpitch":9},{"pitches":[{"pitch":9,"name":"e","verticalPos":9,"highestVert":15}],"duration":0.125,"el_type":"note","averagepitch":9,"minpitch":9,"maxpitch":9},{"pitches":[{"pitch":8,"name":"d","verticalPos":8,"highestVert":14}],"duration":0.125,"el_type":"note","averagepitch":8,"minpitch":8,"maxpitch":8},{"pitches":[{"pitch":8,"name":"d","verticalPos":8,"highestVert":14}],"duration":0.125,"el_type":"note","endBeam":True,"averagepitch":8,"minpitch":8,"maxpitch":8},{"type":"bar_thin","el_type":"bar"}],[{"direction":"down","el_type":"stem"},{"type":"bar_thin","el_type":"bar"},{"pitches":[{"accidental":"dblflat","pitch":1,"name":"__D","verticalPos":1,"highestVert":1}],"duration":0.5,"el_type":"note","averagepitch":1,"minpitch":1,"maxpitch":1},{"pitches":[{"pitch":4,"name":"G","verticalPos":4,"highestVert":4}],"duration":0.5,"el_type":"note","averagepitch":4,"minpitch":4,"maxpitch":4},{"type":"bar_thin","el_type":"bar"},{"pitches":[{"pitch":4,"name":"G","verticalPos":4,"highestVert":4}],"duration":0.25,"el_type":"note","averagepitch":4,"minpitch":4,"maxpitch":4},{"pitches":[{"pitch":5,"name":"A","verticalPos":5,"highestVert":5}],"duration":0.25,"el_type":"note","averagepitch":5,"minpitch":5,"maxpitch":5},{"pitches":[{"pitch":4,"name":"G","verticalPos":4,"highestVert":4}],"duration":0.25,"el_type":"note","averagepitch":4,"minpitch":4,"maxpitch":4},{"pitches":[{"pitch":5,"name":"A","verticalPos":5,"highestVert":5}],"duration":0.25,"el_type":"note","averagepitch":5,"minpitch":5,"maxpitch":5},{"type":"bar_thin","el_type":"bar"}]],"clef":{"type":"treble","el_type":"clef"},"key":{"accidentals":[],"root":"C","acc":"","mode":"","el_type":"keySignature"},"title":["Eins","Zwei"],"meter":{"type":"cut_time","el_type":"timeSignature"}},{"voices":[[{"type":"bar_thin_thin","el_type":"bar"},{"type":"bar_thin","el_type":"bar"}]],"clef":{"type":"bass","el_type":"clef"},"key":{"accidentals":[],"root":"C","acc":"","mode":"","el_type":"keySignature"},"title":["Drei"],"meter":{"type":"cut_time","el_type":"timeSignature"}}]}]
    analysis_abc_strings, informations, error = get_analyzed_abc_strings(truncated_lines)
    assert analysis_abc_strings == ''
    assert informations == []
    assert error == 'There are different end_times in the same line!'


def test_get_analyzed_abc_strings():
    """
    Tested music:

    X: 1
    T: Test
    M:C|
    L:1/8
    Q:1/4=78
    %%score (1 2) (3)
    V:1  clef=treble  name="Eins"   snm="1"
    V:2  clef=treble  name="Zwei"  snm="2"
    V:3  clef=bass    name="Drei"    snm="3"  octave=-2
    K: C
    %1
    [V:1] | c2d2e2f2 | ggffeedd |
    [V:2] | __D4 G4 | G2A2G2A2 |
    [V:3] | C8 G,8 |
    %3
    K: Bm
    [V:1] | (3::2 _c4||c2 f'3 g' | ^e'6 f'2 | 
    [V:2] | =F | F| F |::| F (5 FFFFF F2 F8 |
    [V:3] F16
    %5
    M: 3/8
    [V:1] | (5 Bc^de^A || __g || g | g | 
    [V:2] 
    [V:3]
    """
    truncated_lines = [{"staff":[{"voices":[[{"el_type":"stem","direction":"up"},{"type":"bar_thin","el_type":"bar"},{"pitches":[{"pitch":7,"name":"c","verticalPos":7,"highestVert":13}],"duration":0.25,"el_type":"note","averagepitch":7,"minpitch":7,"maxpitch":7},{"pitches":[{"pitch":8,"name":"d","verticalPos":8,"highestVert":14}],"duration":0.25,"el_type":"note","averagepitch":8,"minpitch":8,"maxpitch":8},{"pitches":[{"pitch":9,"name":"e","verticalPos":9,"highestVert":15}],"duration":0.25,"el_type":"note","averagepitch":9,"minpitch":9,"maxpitch":9},{"pitches":[{"pitch":10,"name":"f","verticalPos":10,"highestVert":16}],"duration":0.25,"el_type":"note","averagepitch":10,"minpitch":10,"maxpitch":10},{"type":"bar_thin","el_type":"bar"},{"pitches":[{"pitch":11,"name":"g","verticalPos":11,"highestVert":17}],"duration":0.125,"el_type":"note","startBeam":True,"averagepitch":11,"minpitch":11,"maxpitch":11},{"pitches":[{"pitch":11,"name":"g","verticalPos":11,"highestVert":17}],"duration":0.125,"el_type":"note","averagepitch":11,"minpitch":11,"maxpitch":11},{"pitches":[{"pitch":10,"name":"f","verticalPos":10,"highestVert":16}],"duration":0.125,"el_type":"note","averagepitch":10,"minpitch":10,"maxpitch":10},{"pitches":[{"pitch":10,"name":"f","verticalPos":10,"highestVert":16}],"duration":0.125,"el_type":"note","averagepitch":10,"minpitch":10,"maxpitch":10},{"pitches":[{"pitch":9,"name":"e","verticalPos":9,"highestVert":15}],"duration":0.125,"el_type":"note","averagepitch":9,"minpitch":9,"maxpitch":9},{"pitches":[{"pitch":9,"name":"e","verticalPos":9,"highestVert":15}],"duration":0.125,"el_type":"note","averagepitch":9,"minpitch":9,"maxpitch":9},{"pitches":[{"pitch":8,"name":"d","verticalPos":8,"highestVert":14}],"duration":0.125,"el_type":"note","averagepitch":8,"minpitch":8,"maxpitch":8},{"pitches":[{"pitch":8,"name":"d","verticalPos":8,"highestVert":14}],"duration":0.125,"el_type":"note","endBeam":True,"averagepitch":8,"minpitch":8,"maxpitch":8},{"type":"bar_thin","el_type":"bar"}],[{"direction":"down","el_type":"stem"},{"type":"bar_thin","el_type":"bar"},{"pitches":[{"accidental":"dblflat","pitch":1,"name":"__D","verticalPos":1,"highestVert":1}],"duration":0.5,"el_type":"note","averagepitch":1,"minpitch":1,"maxpitch":1},{"pitches":[{"pitch":4,"name":"G","verticalPos":4,"highestVert":4}],"duration":0.5,"el_type":"note","averagepitch":4,"minpitch":4,"maxpitch":4},{"type":"bar_thin","el_type":"bar"},{"pitches":[{"pitch":4,"name":"G","verticalPos":4,"highestVert":4}],"duration":0.25,"el_type":"note","averagepitch":4,"minpitch":4,"maxpitch":4},{"pitches":[{"pitch":5,"name":"A","verticalPos":5,"highestVert":5}],"duration":0.25,"el_type":"note","averagepitch":5,"minpitch":5,"maxpitch":5},{"pitches":[{"pitch":4,"name":"G","verticalPos":4,"highestVert":4}],"duration":0.25,"el_type":"note","averagepitch":4,"minpitch":4,"maxpitch":4},{"pitches":[{"pitch":5,"name":"A","verticalPos":5,"highestVert":5}],"duration":0.25,"el_type":"note","averagepitch":5,"minpitch":5,"maxpitch":5},{"type":"bar_thin","el_type":"bar"}]],"clef":{"type":"treble","el_type":"clef"},"key":{"accidentals":[],"root":"C","acc":"","mode":"","el_type":"keySignature"},"title":["Eins","Zwei"],"meter":{"type":"cut_time","el_type":"timeSignature"}},{"voices":[[{"type":"bar_thin","el_type":"bar"},{"pitches":[{"pitch":-14,"name":"C","verticalPos":-2,"highestVert":-2}],"duration":1,"el_type":"note","averagepitch":-2,"minpitch":-2,"maxpitch":-2},{"pitches":[{"pitch":-17,"name":"G,","verticalPos":-5,"highestVert":-5}],"duration":1,"el_type":"note","averagepitch":-5,"minpitch":-5,"maxpitch":-5},{"type":"bar_thin","el_type":"bar"},{"accidentals":[{"acc":"sharp","note":"f","verticalPos":10},{"acc":"sharp","note":"c","verticalPos":7}],"root":"B","acc":"","mode":"m","el_type":"keySignature"}]],"clef":{"type":"bass","el_type":"clef"},"key":{"accidentals":[],"root":"C","acc":"","mode":"","el_type":"keySignature"},"title":["Drei"],"meter":{"type":"cut_time","el_type":"timeSignature"}}]},{"staff":[{"voices":[[{"el_type":"stem","direction":"up"},{"type":"bar_thin","el_type":"bar"},{"startTriplet":3,"tripletMultiplier":0.6666666666666666,"tripletR":2,"pitches":[{"accidental":"flat","pitch":7,"name":"_c","verticalPos":7,"highestVert":13}],"duration":0.5,"el_type":"note","averagepitch":7,"minpitch":7,"maxpitch":7},{"type":"bar_thin_thin","el_type":"bar"},{"pitches":[{"pitch":7,"name":"c","verticalPos":7,"highestVert":13}],"duration":0.25,"endTriplet":True,"el_type":"note","averagepitch":7,"minpitch":7,"maxpitch":7},{"pitches":[{"pitch":17,"name":"f'","verticalPos":17,"highestVert":23}],"duration":0.375,"el_type":"note","averagepitch":17,"minpitch":17,"maxpitch":17},{"pitches":[{"pitch":18,"name":"g'","verticalPos":18,"highestVert":24}],"duration":0.125,"el_type":"note","averagepitch":18,"minpitch":18,"maxpitch":18},{"type":"bar_thin","el_type":"bar"},{"pitches":[{"accidental":"sharp","pitch":16,"name":"^e'","verticalPos":16,"highestVert":22}],"duration":0.75,"el_type":"note","averagepitch":16,"minpitch":16,"maxpitch":16},{"pitches":[{"pitch":17,"name":"f'","verticalPos":17,"highestVert":23}],"duration":0.25,"el_type":"note","averagepitch":17,"minpitch":17,"maxpitch":17},{"type":"bar_thin","el_type":"bar"}],[{"direction":"down","el_type":"stem"},{"type":"bar_thin","el_type":"bar"},{"pitches":[{"accidental":"natural","pitch":3,"name":"=F","verticalPos":3,"highestVert":3}],"duration":0.125,"el_type":"note","averagepitch":3,"minpitch":3,"maxpitch":3},{"type":"bar_thin","el_type":"bar"},{"pitches":[{"pitch":3,"name":"F","verticalPos":3,"highestVert":3}],"duration":0.125,"el_type":"note","averagepitch":3,"minpitch":3,"maxpitch":3},{"type":"bar_thin","el_type":"bar"},{"pitches":[{"pitch":3,"name":"F","verticalPos":3,"highestVert":3}],"duration":0.125,"el_type":"note","averagepitch":3,"minpitch":3,"maxpitch":3},{"type":"bar_left_repeat","el_type":"bar"},{"type":"bar_thin","el_type":"bar"},{"pitches":[{"pitch":3,"name":"F","verticalPos":3,"highestVert":3}],"duration":0.125,"el_type":"note","averagepitch":3,"minpitch":3,"maxpitch":3},{"startTriplet":5,"tripletMultiplier":0.4,"tripletR":5,"pitches":[{"pitch":3,"name":"F","verticalPos":3,"highestVert":3}],"duration":0.125,"el_type":"note","startBeam":True,"averagepitch":3,"minpitch":3,"maxpitch":3},{"pitches":[{"pitch":3,"name":"F","verticalPos":3,"highestVert":3}],"duration":0.125,"el_type":"note","averagepitch":3,"minpitch":3,"maxpitch":3},{"pitches":[{"pitch":3,"name":"F","verticalPos":3,"highestVert":3}],"duration":0.125,"el_type":"note","averagepitch":3,"minpitch":3,"maxpitch":3},{"pitches":[{"pitch":3,"name":"F","verticalPos":3,"highestVert":3}],"duration":0.125,"el_type":"note","averagepitch":3,"minpitch":3,"maxpitch":3},{"pitches":[{"pitch":3,"name":"F","verticalPos":3,"highestVert":3}],"duration":0.125,"endTriplet":True,"el_type":"note","endBeam":True,"averagepitch":3,"minpitch":3,"maxpitch":3},{"pitches":[{"pitch":3,"name":"F","verticalPos":3,"highestVert":3}],"duration":0.25,"el_type":"note","averagepitch":3,"minpitch":3,"maxpitch":3},{"pitches":[{"pitch":3,"name":"F","verticalPos":3,"highestVert":3}],"duration":1,"el_type":"note","averagepitch":3,"minpitch":3,"maxpitch":3},{"type":"bar_thin","el_type":"bar"}]],"clef":{"type":"treble","el_type":"clef"},"key":{"accidentals":[{"acc":"sharp","note":"f","verticalPos":10},{"acc":"sharp","note":"c","verticalPos":7}],"root":"B","acc":"","mode":"m","el_type":"keySignature"},"title":["1","2"]},{"voices":[[{"pitches":[{"pitch":-11,"name":"F","verticalPos":1,"highestVert":1}],"duration":2,"el_type":"note","averagepitch":1,"minpitch":1,"maxpitch":1}]],"clef":{"type":"bass","el_type":"clef"},"key":{"accidentals":[{"acc":"sharp","note":"f","verticalPos":8},{"acc":"sharp","note":"c","verticalPos":5}],"root":"B","acc":"","mode":"m","el_type":"keySignature"},"title":["3"]}]},{"staff":[{"voices":[[{"type":"bar_thin","el_type":"bar"},{"startTriplet":5,"tripletMultiplier":0.4,"tripletR":5,"pitches":[{"pitch":6,"name":"B","verticalPos":6,"highestVert":6}],"duration":0.125,"el_type":"note","startBeam":True,"averagepitch":6,"minpitch":6,"maxpitch":6},{"pitches":[{"pitch":7,"name":"c","verticalPos":7,"highestVert":7}],"duration":0.125,"el_type":"note","averagepitch":7,"minpitch":7,"maxpitch":7},{"pitches":[{"accidental":"sharp","pitch":8,"name":"^d","verticalPos":8,"highestVert":8}],"duration":0.125,"el_type":"note","averagepitch":8,"minpitch":8,"maxpitch":8},{"pitches":[{"pitch":9,"name":"e","verticalPos":9,"highestVert":9}],"duration":0.125,"el_type":"note","averagepitch":9,"minpitch":9,"maxpitch":9},{"pitches":[{"accidental":"sharp","pitch":5,"name":"^A","verticalPos":5,"highestVert":5}],"duration":0.125,"endTriplet":True,"el_type":"note","endBeam":True,"averagepitch":5,"minpitch":5,"maxpitch":5},{"type":"bar_thin_thin","el_type":"bar"},{"pitches":[{"accidental":"dblflat","pitch":11,"name":"__g","verticalPos":11,"highestVert":11}],"duration":0.125,"el_type":"note","averagepitch":11,"minpitch":11,"maxpitch":11},{"type":"bar_thin_thin","el_type":"bar"},{"pitches":[{"pitch":11,"name":"g","verticalPos":11,"highestVert":11}],"duration":0.125,"el_type":"note","averagepitch":11,"minpitch":11,"maxpitch":11},{"type":"bar_thin","el_type":"bar"},{"pitches":[{"pitch":11,"name":"g","verticalPos":11,"highestVert":11}],"duration":0.125,"el_type":"note","averagepitch":11,"minpitch":11,"maxpitch":11},{"type":"bar_thin","el_type":"bar"}]],"clef":{"type":"treble","el_type":"clef"},"key":{"accidentals":[{"acc":"sharp","note":"f","verticalPos":10},{"acc":"sharp","note":"c","verticalPos":7}],"root":"B","acc":"","mode":"m","el_type":"keySignature"},"title":["1"],"meter":{"type":"specified","value":[{"num":"3","den":"8"}],"el_type":"timeSignature"}}]}]
    
    analysis_abc_strings, informations, error = get_analyzed_abc_strings(truncated_lines)

    expected_analysis_abc_strings = {'header': '\nL:1\nK:none\n', 'events': ['[V: Analysis] [C__D]1/4 [D__DC]1/4 [EGC]1/4 [FGC]1/4 [G]1/8 [G]1/8 [FAG]1/8 [FAG]1/8 [EG]1/8 [EG]1/8 [DAG]1/8 [DAG]1/8\n', '[V: Analysis] [_C=F^F]1/8 [_C=F^F]1/8 [_C=F^F]1/12 [_C=F^F]1/24 [_C=F^F]1/8 [^F=F]1/20 [^F=F]1/20 [^F=F]1/20 [^F=F]1/20 [^F=F]1/20 [^F=F]1/8 [G=F^F]1/8 [^E^F]3/4 [^F]1/4\n', '[V: Analysis] [B]1/20 [^C]1/20 [^D]1/20 [E]1/20 [^A]1/20 [__G]1/8 [G]1/8 [G]1/8\n'], 'harmonic_states': ['w: [C,Cm,Cis,Cism,Es,Em,F,Fm,G,Gm,As,Am,Bb,Bbm]~ [C,Cm,Es,F,G,Gm,Am,Bb]~ [C,F,G]~ [C,F]~ ________\n', 'w: [Fism]~ _____________\n', 'w: [Fism]~ _[Esm,E,Fis]~ [E]~ [B]~ [Fis]~ [As,Asm]~ _\n'], 'sauterian_formula': ['w: ind.~ ind.~ ind.~ ind.~ ind.~ _ind.~ _ind.~ _ind.~ _\n', 'w: D3S15~ ____T1D3~ _____T1D3A7~ T1D3~ T1\n', 'w: S1~ T5~ ind.~ T1~ D3~ D3~ ind.~ _\n'], 'degree_of_dissonance_or_atonal': ['w: con~ ind.~ ind.~ ind.~ con~ _ind.~ _ind.~ _ind.~ _\n', 'w: med~ ____low~ _____A1~ low~ con\n', 'w: con~ con~ con~ con~ con~ con~ con~ _\n']}
    expected_informations = ['The accidental_mode is "bar". Accidentals of a note in a bar now apply for all notes with the same octave_pitch after the note in the bar. The given key accidentals are applied, if there is no accidental in the bar for this pitch.']
    expected_error = None

    assert analysis_abc_strings == expected_analysis_abc_strings
    assert informations == expected_informations
    assert error == expected_error
    

def test_get_analyzed_abc_strings_single_mode():
    """
    Tested music:

    X: 1
    T: Test
    M:3/4
    L:1/8
    Q:1/4=78
    %%score (1 2) (3)
    V:1  clef=treble  name="Eins"   snm="1"
    V:2  clef=treble  name="Zwei"  snm="2"
    V:3  clef=bass    name="Drei"    snm="3"  octave=-2
    K: A
    %1
    [V:1]  =c2c2_e2e2 | ^ggffeedd |
    [V:2] | __D4 G4 | G2^^A2G2A2 |
    [V:3] | =C8 G,8 |
    """
    truncated_lines = [{"staff":[{"voices":[[{"el_type":"stem","direction":"up"},{"pitches":[{"accidental":"natural","pitch":7,"name":"=c","verticalPos":7,"highestVert":13}],"duration":0.25,"el_type":"note","averagepitch":7,"minpitch":7,"maxpitch":7},{"pitches":[{"pitch":7,"name":"c","verticalPos":7,"highestVert":13}],"duration":0.25,"el_type":"note","averagepitch":7,"minpitch":7,"maxpitch":7},{"pitches":[{"accidental":"flat","pitch":9,"name":"_e","verticalPos":9,"highestVert":15}],"duration":0.25,"el_type":"note","averagepitch":9,"minpitch":9,"maxpitch":9},{"pitches":[{"pitch":9,"name":"e","verticalPos":9,"highestVert":15}],"duration":0.25,"el_type":"note","averagepitch":9,"minpitch":9,"maxpitch":9},{"type":"bar_thin","el_type":"bar"},{"pitches":[{"accidental":"sharp","pitch":11,"name":"^g","verticalPos":11,"highestVert":17}],"duration":0.125,"el_type":"note","startBeam":True,"averagepitch":11,"minpitch":11,"maxpitch":11},{"pitches":[{"pitch":11,"name":"g","verticalPos":11,"highestVert":17}],"duration":0.125,"el_type":"note","averagepitch":11,"minpitch":11,"maxpitch":11},{"pitches":[{"pitch":10,"name":"f","verticalPos":10,"highestVert":16}],"duration":0.125,"el_type":"note","averagepitch":10,"minpitch":10,"maxpitch":10},{"pitches":[{"pitch":10,"name":"f","verticalPos":10,"highestVert":16}],"duration":0.125,"el_type":"note","averagepitch":10,"minpitch":10,"maxpitch":10},{"pitches":[{"pitch":9,"name":"e","verticalPos":9,"highestVert":15}],"duration":0.125,"el_type":"note","averagepitch":9,"minpitch":9,"maxpitch":9},{"pitches":[{"pitch":9,"name":"e","verticalPos":9,"highestVert":15}],"duration":0.125,"el_type":"note","averagepitch":9,"minpitch":9,"maxpitch":9},{"pitches":[{"pitch":8,"name":"d","verticalPos":8,"highestVert":14}],"duration":0.125,"el_type":"note","averagepitch":8,"minpitch":8,"maxpitch":8},{"pitches":[{"pitch":8,"name":"d","verticalPos":8,"highestVert":14}],"duration":0.125,"el_type":"note","endBeam":True,"averagepitch":8,"minpitch":8,"maxpitch":8},{"type":"bar_thin","el_type":"bar"}],[{"direction":"down","el_type":"stem"},{"type":"bar_thin","el_type":"bar"},{"pitches":[{"accidental":"dblflat","pitch":1,"name":"__D","verticalPos":1,"highestVert":1}],"duration":0.5,"el_type":"note","averagepitch":1,"minpitch":1,"maxpitch":1},{"pitches":[{"pitch":4,"name":"G","verticalPos":4,"highestVert":4}],"duration":0.5,"el_type":"note","averagepitch":4,"minpitch":4,"maxpitch":4},{"type":"bar_thin","el_type":"bar"},{"pitches":[{"pitch":4,"name":"G","verticalPos":4,"highestVert":4}],"duration":0.25,"el_type":"note","averagepitch":4,"minpitch":4,"maxpitch":4},{"pitches":[{"accidental":"dblsharp","pitch":5,"name":"^^A","verticalPos":5,"highestVert":5}],"duration":0.25,"el_type":"note","averagepitch":5,"minpitch":5,"maxpitch":5},{"pitches":[{"pitch":4,"name":"G","verticalPos":4,"highestVert":4}],"duration":0.25,"el_type":"note","averagepitch":4,"minpitch":4,"maxpitch":4},{"pitches":[{"pitch":5,"name":"A","verticalPos":5,"highestVert":5}],"duration":0.25,"el_type":"note","averagepitch":5,"minpitch":5,"maxpitch":5},{"type":"bar_thin","el_type":"bar"}]],"clef":{"type":"treble","el_type":"clef"},"key":{"accidentals":[{"acc":"sharp","note":"f","verticalPos":10},{"acc":"sharp","note":"c","verticalPos":7},{"acc":"sharp","note":"g","verticalPos":11}],"root":"A","acc":"","mode":"","el_type":"keySignature"},"title":["Eins","Zwei"],"meter":{"type":"specified","value":[{"num":"3","den":"4"}],"el_type":"timeSignature"}},{"voices":[[{"type":"bar_thin","el_type":"bar"},{"pitches":[{"accidental":"natural","pitch":-14,"name":"=C","verticalPos":-2,"highestVert":-2}],"duration":1,"el_type":"note","averagepitch":-2,"minpitch":-2,"maxpitch":-2},{"pitches":[{"pitch":-17,"name":"G,","verticalPos":-5,"highestVert":-5}],"duration":1,"el_type":"note","averagepitch":-5,"minpitch":-5,"maxpitch":-5},{"type":"bar_thin","el_type":"bar"}]],"clef":{"type":"bass","el_type":"clef"},"key":{"accidentals":[{"acc":"sharp","note":"f","verticalPos":8},{"acc":"sharp","note":"c","verticalPos":5},{"acc":"sharp","note":"g","verticalPos":9}],"root":"A","acc":"","mode":"","el_type":"keySignature"},"title":["Drei"],"meter":{"type":"specified","value":[{"num":"3","den":"4"}],"el_type":"timeSignature"}}]}]

    analysis_abc_strings, informations, error = get_analyzed_abc_strings(truncated_lines)

    expected_analysis_abc_strings = {'header': '\nL:1\nK:none\n', 'events': ['[V: Analysis] [=C__D]1/4 [^C__D=C]1/4 [_E^G=C]1/4 [E^G=C]1/4 [^G]1/8 [^G]1/8 [^F^^A^G]1/8 [^F^^A^G]1/8 [E^G]1/8 [E^G]1/8 [DA^G]1/8 [DA^G]1/8\n'], 'harmonic_states': ['w: [C,Cm,Cis,Cism,Es,Em,F,Fm,G,Gm,As,Am,Bb,Bbm]~ [Cis,Cism,Fm,As,Bbm]~ [Cis,Cism,As]~ [Cism]~ __[E]~ ___[A]~ _\n'], 'sauterian_formula': ['w: ind.~ ind.~ ind.~ T35D13~ T5~ _T35D15~ _T13~ _D3S15~ _\n'], 'degree_of_dissonance_or_atonal': ['w: con~ ind.~ ind.~ fcon~ con~ _low~ _con~ _med~ _\n']}
    expected_informations = ['The accidental_mode is "single". Accidentals of a note apply only for a single note.']
    expected_error = None

    assert analysis_abc_strings == expected_analysis_abc_strings
    assert informations == expected_informations
    assert error == expected_error


def test_get_analyzed_abc_strings_lines_with_different_amount_of_staffs():
    """
    Tested music:

    X: 1
    T: Test
    M:C|
    L:1/8
    Q:1/4=78
    %%score (1 2) (3)
    V:1  clef=treble  name="Eins"   snm="1"
    V:2  clef=treble  name="Zwei"  snm="2"
    V:3  clef=bass    name="Drei"    snm="3"  octave=-2
    K: C
    %1
    [V:1] | c2d2e2f2 | ggffeedd |
    [V:2] | __D4 G4 | G2A2G2A2 |
    [V:3] | C8 G,8 |
    %3
    K: Bm
    [V:1] | (3::2 _c4||c2 f'3 g' | ^e'6 f'2 | 
    [V:2] | =F | F| F |::| F (5 FFFFF F2 F8 |
    [V:3] F16
    %5
    M: 3/8
    [V:1] | (5 Bc^de^A || __g || g | g |
    """
    truncated_lines = [{"staff":[{"voices":[[{"el_type":"stem","direction":"up"},{"type":"bar_thin","el_type":"bar"},{"pitches":[{"pitch":7,"name":"c","verticalPos":7,"highestVert":13}],"duration":0.25,"el_type":"note","averagepitch":7,"minpitch":7,"maxpitch":7},{"pitches":[{"pitch":8,"name":"d","verticalPos":8,"highestVert":14}],"duration":0.25,"el_type":"note","averagepitch":8,"minpitch":8,"maxpitch":8},{"pitches":[{"pitch":9,"name":"e","verticalPos":9,"highestVert":15}],"duration":0.25,"el_type":"note","averagepitch":9,"minpitch":9,"maxpitch":9},{"pitches":[{"pitch":10,"name":"f","verticalPos":10,"highestVert":16}],"duration":0.25,"el_type":"note","averagepitch":10,"minpitch":10,"maxpitch":10},{"type":"bar_thin","el_type":"bar"},{"pitches":[{"pitch":11,"name":"g","verticalPos":11,"highestVert":17}],"duration":0.125,"el_type":"note","startBeam":True,"averagepitch":11,"minpitch":11,"maxpitch":11},{"pitches":[{"pitch":11,"name":"g","verticalPos":11,"highestVert":17}],"duration":0.125,"el_type":"note","averagepitch":11,"minpitch":11,"maxpitch":11},{"pitches":[{"pitch":10,"name":"f","verticalPos":10,"highestVert":16}],"duration":0.125,"el_type":"note","averagepitch":10,"minpitch":10,"maxpitch":10},{"pitches":[{"pitch":10,"name":"f","verticalPos":10,"highestVert":16}],"duration":0.125,"el_type":"note","averagepitch":10,"minpitch":10,"maxpitch":10},{"pitches":[{"pitch":9,"name":"e","verticalPos":9,"highestVert":15}],"duration":0.125,"el_type":"note","averagepitch":9,"minpitch":9,"maxpitch":9},{"pitches":[{"pitch":9,"name":"e","verticalPos":9,"highestVert":15}],"duration":0.125,"el_type":"note","averagepitch":9,"minpitch":9,"maxpitch":9},{"pitches":[{"pitch":8,"name":"d","verticalPos":8,"highestVert":14}],"duration":0.125,"el_type":"note","averagepitch":8,"minpitch":8,"maxpitch":8},{"pitches":[{"pitch":8,"name":"d","verticalPos":8,"highestVert":14}],"duration":0.125,"el_type":"note","endBeam":True,"averagepitch":8,"minpitch":8,"maxpitch":8},{"type":"bar_thin","el_type":"bar"}],[{"direction":"down","el_type":"stem"},{"type":"bar_thin","el_type":"bar"},{"pitches":[{"accidental":"dblflat","pitch":1,"name":"__D","verticalPos":1,"highestVert":1}],"duration":0.5,"el_type":"note","averagepitch":1,"minpitch":1,"maxpitch":1},{"pitches":[{"pitch":4,"name":"G","verticalPos":4,"highestVert":4}],"duration":0.5,"el_type":"note","averagepitch":4,"minpitch":4,"maxpitch":4},{"type":"bar_thin","el_type":"bar"},{"pitches":[{"pitch":4,"name":"G","verticalPos":4,"highestVert":4}],"duration":0.25,"el_type":"note","averagepitch":4,"minpitch":4,"maxpitch":4},{"pitches":[{"pitch":5,"name":"A","verticalPos":5,"highestVert":5}],"duration":0.25,"el_type":"note","averagepitch":5,"minpitch":5,"maxpitch":5},{"pitches":[{"pitch":4,"name":"G","verticalPos":4,"highestVert":4}],"duration":0.25,"el_type":"note","averagepitch":4,"minpitch":4,"maxpitch":4},{"pitches":[{"pitch":5,"name":"A","verticalPos":5,"highestVert":5}],"duration":0.25,"el_type":"note","averagepitch":5,"minpitch":5,"maxpitch":5},{"type":"bar_thin","el_type":"bar"}]],"clef":{"type":"treble","el_type":"clef"},"key":{"accidentals":[],"root":"C","acc":"","mode":"","el_type":"keySignature"},"title":["Eins","Zwei"],"meter":{"type":"cut_time","el_type":"timeSignature"}},{"voices":[[{"type":"bar_thin","el_type":"bar"},{"pitches":[{"pitch":-14,"name":"C","verticalPos":-2,"highestVert":-2}],"duration":1,"el_type":"note","averagepitch":-2,"minpitch":-2,"maxpitch":-2},{"pitches":[{"pitch":-17,"name":"G,","verticalPos":-5,"highestVert":-5}],"duration":1,"el_type":"note","averagepitch":-5,"minpitch":-5,"maxpitch":-5},{"type":"bar_thin","el_type":"bar"},{"accidentals":[{"acc":"sharp","note":"f","verticalPos":10},{"acc":"sharp","note":"c","verticalPos":7}],"root":"B","acc":"","mode":"m","el_type":"keySignature"}]],"clef":{"type":"bass","el_type":"clef"},"key":{"accidentals":[],"root":"C","acc":"","mode":"","el_type":"keySignature"},"title":["Drei"],"meter":{"type":"cut_time","el_type":"timeSignature"}}]},{"staff":[{"voices":[[{"el_type":"stem","direction":"up"},{"type":"bar_thin","el_type":"bar"},{"startTriplet":3,"tripletMultiplier":0.6666666666666666,"tripletR":2,"pitches":[{"accidental":"flat","pitch":7,"name":"_c","verticalPos":7,"highestVert":13}],"duration":0.5,"el_type":"note","averagepitch":7,"minpitch":7,"maxpitch":7},{"type":"bar_thin_thin","el_type":"bar"},{"pitches":[{"pitch":7,"name":"c","verticalPos":7,"highestVert":13}],"duration":0.25,"endTriplet":True,"el_type":"note","averagepitch":7,"minpitch":7,"maxpitch":7},{"pitches":[{"pitch":17,"name":"f'","verticalPos":17,"highestVert":23}],"duration":0.375,"el_type":"note","averagepitch":17,"minpitch":17,"maxpitch":17},{"pitches":[{"pitch":18,"name":"g'","verticalPos":18,"highestVert":24}],"duration":0.125,"el_type":"note","averagepitch":18,"minpitch":18,"maxpitch":18},{"type":"bar_thin","el_type":"bar"},{"pitches":[{"accidental":"sharp","pitch":16,"name":"^e'","verticalPos":16,"highestVert":22}],"duration":0.75,"el_type":"note","averagepitch":16,"minpitch":16,"maxpitch":16},{"pitches":[{"pitch":17,"name":"f'","verticalPos":17,"highestVert":23}],"duration":0.25,"el_type":"note","averagepitch":17,"minpitch":17,"maxpitch":17},{"type":"bar_thin","el_type":"bar"}],[{"direction":"down","el_type":"stem"},{"type":"bar_thin","el_type":"bar"},{"pitches":[{"accidental":"natural","pitch":3,"name":"=F","verticalPos":3,"highestVert":3}],"duration":0.125,"el_type":"note","averagepitch":3,"minpitch":3,"maxpitch":3},{"type":"bar_thin","el_type":"bar"},{"pitches":[{"pitch":3,"name":"F","verticalPos":3,"highestVert":3}],"duration":0.125,"el_type":"note","averagepitch":3,"minpitch":3,"maxpitch":3},{"type":"bar_thin","el_type":"bar"},{"pitches":[{"pitch":3,"name":"F","verticalPos":3,"highestVert":3}],"duration":0.125,"el_type":"note","averagepitch":3,"minpitch":3,"maxpitch":3},{"type":"bar_left_repeat","el_type":"bar"},{"type":"bar_thin","el_type":"bar"},{"pitches":[{"pitch":3,"name":"F","verticalPos":3,"highestVert":3}],"duration":0.125,"el_type":"note","averagepitch":3,"minpitch":3,"maxpitch":3},{"startTriplet":5,"tripletMultiplier":0.4,"tripletR":5,"pitches":[{"pitch":3,"name":"F","verticalPos":3,"highestVert":3}],"duration":0.125,"el_type":"note","startBeam":True,"averagepitch":3,"minpitch":3,"maxpitch":3},{"pitches":[{"pitch":3,"name":"F","verticalPos":3,"highestVert":3}],"duration":0.125,"el_type":"note","averagepitch":3,"minpitch":3,"maxpitch":3},{"pitches":[{"pitch":3,"name":"F","verticalPos":3,"highestVert":3}],"duration":0.125,"el_type":"note","averagepitch":3,"minpitch":3,"maxpitch":3},{"pitches":[{"pitch":3,"name":"F","verticalPos":3,"highestVert":3}],"duration":0.125,"el_type":"note","averagepitch":3,"minpitch":3,"maxpitch":3},{"pitches":[{"pitch":3,"name":"F","verticalPos":3,"highestVert":3}],"duration":0.125,"endTriplet":True,"el_type":"note","endBeam":True,"averagepitch":3,"minpitch":3,"maxpitch":3},{"pitches":[{"pitch":3,"name":"F","verticalPos":3,"highestVert":3}],"duration":0.25,"el_type":"note","averagepitch":3,"minpitch":3,"maxpitch":3},{"pitches":[{"pitch":3,"name":"F","verticalPos":3,"highestVert":3}],"duration":1,"el_type":"note","averagepitch":3,"minpitch":3,"maxpitch":3},{"type":"bar_thin","el_type":"bar"}]],"clef":{"type":"treble","el_type":"clef"},"key":{"accidentals":[{"acc":"sharp","note":"f","verticalPos":10},{"acc":"sharp","note":"c","verticalPos":7}],"root":"B","acc":"","mode":"m","el_type":"keySignature"},"title":["1","2"]},{"voices":[[{"pitches":[{"pitch":-11,"name":"F","verticalPos":1,"highestVert":1}],"duration":2,"el_type":"note","averagepitch":1,"minpitch":1,"maxpitch":1}]],"clef":{"type":"bass","el_type":"clef"},"key":{"accidentals":[{"acc":"sharp","note":"f","verticalPos":8},{"acc":"sharp","note":"c","verticalPos":5}],"root":"B","acc":"","mode":"m","el_type":"keySignature"},"title":["3"]}]},{"staff":[{"voices":[[{"type":"bar_thin","el_type":"bar"},{"startTriplet":5,"tripletMultiplier":0.4,"tripletR":5,"pitches":[{"pitch":6,"name":"B","verticalPos":6,"highestVert":6}],"duration":0.125,"el_type":"note","startBeam":True,"averagepitch":6,"minpitch":6,"maxpitch":6},{"pitches":[{"pitch":7,"name":"c","verticalPos":7,"highestVert":7}],"duration":0.125,"el_type":"note","averagepitch":7,"minpitch":7,"maxpitch":7},{"pitches":[{"accidental":"sharp","pitch":8,"name":"^d","verticalPos":8,"highestVert":8}],"duration":0.125,"el_type":"note","averagepitch":8,"minpitch":8,"maxpitch":8},{"pitches":[{"pitch":9,"name":"e","verticalPos":9,"highestVert":9}],"duration":0.125,"el_type":"note","averagepitch":9,"minpitch":9,"maxpitch":9},{"pitches":[{"accidental":"sharp","pitch":5,"name":"^A","verticalPos":5,"highestVert":5}],"duration":0.125,"endTriplet":True,"el_type":"note","endBeam":True,"averagepitch":5,"minpitch":5,"maxpitch":5},{"type":"bar_thin_thin","el_type":"bar"},{"pitches":[{"accidental":"dblflat","pitch":11,"name":"__g","verticalPos":11,"highestVert":11}],"duration":0.125,"el_type":"note","averagepitch":11,"minpitch":11,"maxpitch":11},{"type":"bar_thin_thin","el_type":"bar"},{"pitches":[{"pitch":11,"name":"g","verticalPos":11,"highestVert":11}],"duration":0.125,"el_type":"note","averagepitch":11,"minpitch":11,"maxpitch":11},{"type":"bar_thin","el_type":"bar"},{"pitches":[{"pitch":11,"name":"g","verticalPos":11,"highestVert":11}],"duration":0.125,"el_type":"note","averagepitch":11,"minpitch":11,"maxpitch":11},{"type":"bar_thin","el_type":"bar"}]],"clef":{"type":"treble","el_type":"clef"},"key":{"accidentals":[{"acc":"sharp","note":"f","verticalPos":10},{"acc":"sharp","note":"c","verticalPos":7}],"root":"B","acc":"","mode":"m","el_type":"keySignature"},"title":["1"],"meter":{"type":"specified","value":[{"num":"3","den":"8"}],"el_type":"timeSignature"}}]}]

    analysis_abc_strings, informations, error = get_analyzed_abc_strings(truncated_lines)

    expected_analysis_abc_strings = {'header': '\nL:1\nK:none\n', 'events': ['[V: Analysis] [C__D]1/4 [D__DC]1/4 [EGC]1/4 [FGC]1/4 [G]1/8 [G]1/8 [FAG]1/8 [FAG]1/8 [EG]1/8 [EG]1/8 [DAG]1/8 [DAG]1/8\n', '[V: Analysis] [_C=F^F]1/8 [_C=F^F]1/8 [_C=F^F]1/12 [_C=F^F]1/24 [_C=F^F]1/8 [^F=F]1/20 [^F=F]1/20 [^F=F]1/20 [^F=F]1/20 [^F=F]1/20 [^F=F]1/8 [G=F^F]1/8 [^E^F]3/4 [^F]1/4\n', '[V: Analysis] [B]1/20 [^C]1/20 [^D]1/20 [E]1/20 [^A]1/20 [__G]1/8 [G]1/8 [G]1/8\n'], 'harmonic_states': ['w: [C,Cm,Cis,Cism,Es,Em,F,Fm,G,Gm,As,Am,Bb,Bbm]~ [C,Cm,Es,F,G,Gm,Am,Bb]~ [C,F,G]~ [C,F]~ ________\n', 'w: [Fism]~ _____________\n', 'w: [Fism]~ _[Esm,E,Fis]~ [E]~ [B]~ [Fis]~ [As,Asm]~ _\n'], 'sauterian_formula': ['w: ind.~ ind.~ ind.~ ind.~ ind.~ _ind.~ _ind.~ _ind.~ _\n', 'w: D3S15~ ____T1D3~ _____T1D3A7~ T1D3~ T1\n', 'w: S1~ T5~ ind.~ T1~ D3~ D3~ ind.~ _\n'], 'degree_of_dissonance_or_atonal': ['w: con~ ind.~ ind.~ ind.~ con~ _ind.~ _ind.~ _ind.~ _\n', 'w: med~ ____low~ _____A1~ low~ con\n', 'w: con~ con~ con~ con~ con~ con~ con~ _\n']}
    expected_informations = ['The accidental_mode is "bar". Accidentals of a note in a bar now apply for all notes with the same octave_pitch after the note in the bar. The given key accidentals are applied, if there is no accidental in the bar for this pitch.']
    expected_error = None

    assert analysis_abc_strings == expected_analysis_abc_strings
    assert informations == expected_informations
    assert error == expected_error


def test_get_analyzed_abc_strings_tristan():
    """
    Tested music:

    X: 1
    T: Tristan Prelude
    L:1/8
    M:6/8
    Q:1/8=100
    %%staves (S A) B
    K:Am
    V:S treble
    z | z6 | (^G3-G2 A | ^A B2-B) zz
    V:A treble
    (A, | F3-F2 E | ^D6 | =D3-)D zz
    V:B bass octave=-2
    z | z6 | ([fb]6 | [e^g]3-)[e^g] zz
    """
    truncated_lines = [{"staff":[{"voices":[[{"el_type":"stem","direction":"up"},{"rest":{"type":"rest"},"duration":0.125,"el_type":"note","averagepitch":11,"minpitch":11,"maxpitch":11},{"type":"bar_thin","el_type":"bar"},{"rest":{"type":"whole"},"duration":0.75,"el_type":"note","averagepitch":11,"minpitch":11,"maxpitch":11},{"type":"bar_thin","el_type":"bar"},{"pitches":[{"accidental":"sharp","pitch":4,"name":"^G","startSlur":[{"label":101}],"startTie":{},"verticalPos":4,"highestVert":10}],"duration":0.375,"el_type":"note","averagepitch":4,"minpitch":4,"maxpitch":4},{"pitches":[{"pitch":4,"name":"G","endTie":True,"verticalPos":4,"highestVert":10}],"duration":0.25,"el_type":"note","averagepitch":4,"minpitch":4,"maxpitch":4},{"pitches":[{"pitch":5,"name":"A","verticalPos":5,"highestVert":11}],"duration":0.125,"el_type":"note","averagepitch":5,"minpitch":5,"maxpitch":5},{"type":"bar_thin","el_type":"bar"},{"pitches":[{"accidental":"sharp","pitch":5,"name":"^A","verticalPos":5,"highestVert":11}],"duration":0.125,"el_type":"note","averagepitch":5,"minpitch":5,"maxpitch":5},{"pitches":[{"pitch":6,"name":"B","startTie":{},"verticalPos":6,"highestVert":12}],"duration":0.25,"el_type":"note","averagepitch":6,"minpitch":6,"maxpitch":6},{"pitches":[{"pitch":6,"name":"B","endSlur":[101],"endTie":True,"verticalPos":6,"highestVert":12}],"duration":0.125,"el_type":"note","averagepitch":6,"minpitch":6,"maxpitch":6},{"rest":{"type":"rest"},"duration":0.125,"el_type":"note","averagepitch":11,"minpitch":11,"maxpitch":11},{"rest":{"type":"rest"},"duration":0.125,"el_type":"note","averagepitch":11,"minpitch":11,"maxpitch":11}],[{"direction":"down","el_type":"stem"},{"pitches":[{"pitch":-2,"name":"A,","startSlur":[{"label":101}],"verticalPos":-2,"highestVert":-2}],"duration":0.125,"el_type":"note","averagepitch":-2,"minpitch":-2,"maxpitch":-2},{"type":"bar_thin","el_type":"bar"},{"pitches":[{"pitch":3,"name":"F","startTie":{},"verticalPos":3,"highestVert":3}],"duration":0.375,"el_type":"note","averagepitch":3,"minpitch":3,"maxpitch":3},{"pitches":[{"pitch":3,"name":"F","endTie":True,"verticalPos":3,"highestVert":3}],"duration":0.25,"el_type":"note","averagepitch":3,"minpitch":3,"maxpitch":3},{"pitches":[{"pitch":2,"name":"E","verticalPos":2,"highestVert":2}],"duration":0.125,"el_type":"note","averagepitch":2,"minpitch":2,"maxpitch":2},{"type":"bar_thin","el_type":"bar"},{"pitches":[{"accidental":"sharp","pitch":1,"name":"^D","verticalPos":1,"highestVert":1}],"duration":0.75,"el_type":"note","averagepitch":1,"minpitch":1,"maxpitch":1},{"type":"bar_thin","el_type":"bar"},{"pitches":[{"accidental":"natural","pitch":1,"name":"=D","endSlur":[101],"startTie":{},"verticalPos":1,"highestVert":1}],"duration":0.375,"el_type":"note","averagepitch":1,"minpitch":1,"maxpitch":1},{"pitches":[{"pitch":1,"name":"D","endTie":True,"verticalPos":1,"highestVert":1}],"duration":0.125,"el_type":"note","averagepitch":1,"minpitch":1,"maxpitch":1},{"rest":{"type":"rest"},"duration":0.125,"el_type":"note","averagepitch":3,"minpitch":3,"maxpitch":3},{"rest":{"type":"rest"},"duration":0.125,"el_type":"note","averagepitch":3,"minpitch":3,"maxpitch":3}]],"clef":{"type":"treble","el_type":"clef"},"key":{"accidentals":[],"root":"A","acc":"","mode":"m","el_type":"keySignature"},"connectBarLines":"start","meter":{"type":"specified","value":[{"num":"6","den":"8"}],"el_type":"timeSignature"}},{"voices":[[{"rest":{"type":"rest"},"duration":0.125,"el_type":"note","averagepitch":7,"minpitch":7,"maxpitch":7},{"type":"bar_thin","el_type":"bar"},{"rest":{"type":"whole"},"duration":0.75,"el_type":"note","averagepitch":7,"minpitch":7,"maxpitch":7},{"type":"bar_thin","el_type":"bar"},{"startSlur":[{"label":1}],"duration":0.75,"pitches":[{"pitch":-4,"name":"f","verticalPos":8,"highestVert":8},{"pitch":-1,"name":"b","verticalPos":11,"highestVert":11,"startSlur":[{"label":1}]}],"el_type":"note","averagepitch":9.5,"minpitch":8,"maxpitch":11},{"type":"bar_thin","el_type":"bar"},{"duration":0.375,"pitches":[{"pitch":-5,"name":"e","startTie":{},"verticalPos":7,"highestVert":7},{"accidental":"sharp","pitch":-3,"name":"^g","startTie":{},"verticalPos":9,"highestVert":9,"endSlur":[1]}],"endSlur":[1],"el_type":"note","averagepitch":8,"minpitch":7,"maxpitch":9},{"duration":0.125,"pitches":[{"pitch":-5,"name":"e","endTie":True,"verticalPos":7,"highestVert":7},{"accidental":"sharp","pitch":-3,"name":"^g","endTie":True,"verticalPos":9,"highestVert":9}],"el_type":"note","averagepitch":8,"minpitch":7,"maxpitch":9},{"rest":{"type":"rest"},"duration":0.125,"el_type":"note","averagepitch":7,"minpitch":7,"maxpitch":7},{"rest":{"type":"rest"},"duration":0.125,"el_type":"note","averagepitch":7,"minpitch":7,"maxpitch":7}]],"clef":{"type":"bass","el_type":"clef"},"key":{"accidentals":[],"root":"A","acc":"","mode":"m","el_type":"keySignature"},"connectBarLines":"continue","meter":{"type":"specified","value":[{"num":"6","den":"8"}],"el_type":"timeSignature"}}]}]

    analysis_abc_strings, informations, error = get_analyzed_abc_strings(truncated_lines)

    expected_analysis_abc_strings = {'header': '\nL:1\nK:none\n', 'events': ['[V: Analysis] [A]1/8 [F]3/8 [F]1/4 [E]1/8 [^G^DFB]3/8 [^G^DFB]1/4 [A^DFB]1/8 [^A=DE^G]1/8 [B=DE^G]1/4 [B=DE^G]1/8 []1/8 []1/8\n'], 'harmonic_states': ['w: [C,Cism,D,Dm,E,Em,F,Fism,G,Gm,A,Am,Bb,Bbm]~ [C,Dm,F,Fism,Am,Bb,Bbm]~ _[C,Dm,F,Am]~ [Cm]~ __[Es]~ [Am]~ ___\n'], 'sauterian_formula': ['w: ind.~ ind.~ _ind.~ T3D3S13~ _T3D3S1A9~ D13S1A4~ D135S1~ _/~ _\n'], 'degree_of_dissonance_or_atonal': ['w: con~ con~ _con~ high~ _A1~ A1~ med~ _/~ _\n']}
    expected_informations = ['The accidental_mode is "bar". Accidentals of a note in a bar now apply for all notes with the same octave_pitch after the note in the bar. The given key accidentals are applied, if there is no accidental in the bar for this pitch.']
    expected_error = None

    assert analysis_abc_strings == expected_analysis_abc_strings
    assert informations == expected_informations
    assert error == expected_error


def test_get_analyzed_abc_strings_mode_information():
    """
    bar mode music:

    X: 1
    T: Test
    M:C
    L:1/8
    [V:1] | c

    single mode music:

    X: 1
    T: Test
    M:C
    L:1/8
    [V:1] c
    """
    truncated_lines = [{"staff":[{"voices":[[{"type":"bar_thin","el_type":"bar"},{"pitches":[{"pitch":7,"name":"c","verticalPos":7,"highestVert":7}],"duration":0.125,"el_type":"note","averagepitch":7,"minpitch":7,"maxpitch":7}]],"clef":{"type":"treble","el_type":"clef"},"key":{"accidentals":[],"root":"none","acc":"","mode":"","el_type":"keySignature"},"meter":{"type":"common_time","el_type":"timeSignature"}}]}]
    analysis_abc_strings, informations, error = get_analyzed_abc_strings(truncated_lines)
    assert informations == ['The accidental_mode is "bar". Accidentals of a note in a bar now apply for all notes with the same octave_pitch after the note in the bar. The given key accidentals are applied, if there is no accidental in the bar for this pitch.']

    truncated_lines = [{"staff":[{"voices":[[{"pitches":[{"pitch":7,"name":"c","verticalPos":7,"highestVert":7}],"duration":0.125,"el_type":"note","averagepitch":7,"minpitch":7,"maxpitch":7}]],"clef":{"type":"treble","el_type":"clef"},"key":{"accidentals":[],"root":"none","acc":"","mode":"","el_type":"keySignature"},"meter":{"type":"common_time","el_type":"timeSignature"}}]}]
    analysis_abc_strings, informations, error = get_analyzed_abc_strings(truncated_lines)
    assert informations == ['The accidental_mode is "single". Accidentals of a note apply only for a single note.']